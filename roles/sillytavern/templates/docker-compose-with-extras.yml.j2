services:
  sillytavernextras:
    deploy:
        resources:
            limits:
                memory: 4096M
    container_name: sillytavernextras
    hostname: sillytavernextras
    image: cohee1207/sillytavern-extras
    build:
      context: ../extras/
      dockerfile: docker/Dockerfile
      args:
        REQUIREMENTS: requirements.txt
    volumes:
      - "../extras/api_key.txt:/sillytavern-extras/api_key.txt:rw"
      - chromadb-data-volume:/chromadb
      - sillytavernextras-cache-volume:/root/.cache
    ports:
      - "5100:5100"
      - "9000:9000"
    environment:
      - PUID=1000
      - PGID=1000
      - NVIDIA_VISIBLE_DEVICES=all
    entrypoint:
      [
        "python",
        "server.py",
        "--listen",
        "--chroma-port=9000",
        "--enable-modules=caption,summarize,classify,embeddings,websearch,chromadb,coqui-tts",
      ]
    networks:
      - sillytavern
  sillytavern:
    deploy:
        resources:
            limits:
                memory: 4096M
    build: ..
    container_name: sillytavern
    hostname: sillytavern
    image: ghcr.io/sillytavern/sillytavern:latest
    volumes:
      - sillytavern-extensions-volume:/home/node/app/public/scripts/extensions/third-party
      - sillytavern-config-volume:/home/node/app/config
      - sillytavern-data-volume:/home/node/app/data
    ports:
      - "8000:8000"
    environment:
      - PUID=1000
      - PGID=1000
    depends_on:
      - sillytavernextras
    links:
      - sillytavernextras
    networks:
      - sillytavern

networks:
  sillytavern:
    driver: bridge

volumes:
  data:
  chromadb-data-volume:
    name: chromadb-data-volume
    external: true
  sillytavernextras-cache-volume:
    name: sillytavernextras-cache-volume
    external: true
  sillytavern-extensions-volume:
    name: sillytavern-extensions-volume
    external: true
  sillytavern-config-volume:
    name: sillytavern-config-volume
    external: true
  sillytavern-data-volume:
    name: sillytavern-data-volume
    external: true
